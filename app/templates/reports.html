{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1 class="mb-4">Reports</h1>
        <button type="button" class="btn btn-success mb-4" data-bs-toggle="modal" data-bs-target="#createReportModal">
            <i class="bi bi-plus-circle"></i> Create New Report
        </button>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Location</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="reports-table-body">
                            {% for report in reports %}
                            <tr>
                                <td>{{ report.title }}</td>
                                <td>{{ report.location }}</td>
                                <td>{{ report.timestamp }}</td>
                                <td>
                                    <button class="btn btn-sm btn-primary view-report" data-id="{{ report.id }}">View</button>
                                    <button class="btn btn-sm btn-warning edit-report" data-id="{{ report.id }}">Edit</button>
                                    <button class="btn btn-sm btn-danger delete-report" data-id="{{ report.id }}">Delete</button>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="4" class="text-center">No reports found. Create your first report!</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Report Modal -->
<div class="modal fade" id="createReportModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Report</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createReportForm">
                    <div class="mb-3">
                        <label for="reportTitle" class="form-label">Title</label>
                        <input type="text" class="form-control" id="reportTitle" required>
                    </div>
                    <div class="mb-3">
                        <label for="reportContent" class="form-label">Content</label>
                        <textarea class="form-control" id="reportContent" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="reportLocation" class="form-label">Location</label>
                        <input type="text" class="form-control" id="reportLocation" placeholder="e.g., Tashkent, Fergana Valley" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="submitReport">Submit Report</button>
            </div>
        </div>
    </div>
</div>

<!-- View Report Modal -->
<div class="modal fade" id="viewReportModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewReportTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>Location:</strong> <span id="viewReportLocation"></span></p>
                <p><strong>Date:</strong> <span id="viewReportDate"></span></p>
                <hr>
                <div id="viewReportContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Report Modal -->
<div class="modal fade" id="editReportModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Report</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editReportForm">
                    <input type="hidden" id="editReportId">
                    <div class="mb-3">
                        <label for="editReportTitle" class="form-label">Title</label>
                        <input type="text" class="form-control" id="editReportTitle" required>
                    </div>
                    <div class="mb-3">
                        <label for="editReportContent" class="form-label">Content</label>
                        <textarea class="form-control" id="editReportContent" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="editReportLocation" class="form-label">Location</label>
                        <input type="text" class="form-control" id="editReportLocation" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="updateReport">Update Report</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Report Confirmation Modal -->
<div class="modal fade" id="deleteReportModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this report? This action cannot be undone.</p>
                <input type="hidden" id="deleteReportId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Create report modal
    const createReportModal = new bootstrap.Modal(document.getElementById('createReportModal'));
    const viewReportModal = new bootstrap.Modal(document.getElementById('viewReportModal'));
    const editReportModal = new bootstrap.Modal(document.getElementById('editReportModal'));
    const deleteReportModal = new bootstrap.Modal(document.getElementById('deleteReportModal'));
    
    // Submit new report
    document.getElementById('submitReport').addEventListener('click', function() {
        const title = document.getElementById('reportTitle').value;
        const content = document.getElementById('reportContent').value;
        const location = document.getElementById('reportLocation').value;
        
        if (!title || !content || !location) {
            alert('Please fill in all fields');
            return;
        }
        
        fetch('/api/reports', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                title: title,
                content: content,
                location: location
            })
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            }
            throw new Error('Network response was not ok');
        })
        .then(data => {
            createReportModal.hide();
            // Reset form
            document.getElementById('createReportForm').reset();
            // Reload page to show new report
            window.location.reload();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error creating report. Please try again.');
        });
    });
    
    // View report details
    document.querySelectorAll('.view-report').forEach(button => {
        button.addEventListener('click', function() {
            const reportId = this.getAttribute('data-id');
            
            fetch(`/api/reports/${reportId}`)
                .then(response => response.json())
                .then(report => {
                    document.getElementById('viewReportTitle').textContent = report.title;
                    document.getElementById('viewReportLocation').textContent = report.location;
                    document.getElementById('viewReportDate').textContent = report.timestamp;
                    document.getElementById('viewReportContent').textContent = report.content;
                    viewReportModal.show();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error loading report details. Please try again.');
                });
        });
    });
    
    // Open edit modal with report data
    document.querySelectorAll('.edit-report').forEach(button => {
        button.addEventListener('click', function() {
            const reportId = this.getAttribute('data-id');
            
            fetch(`/api/reports/${reportId}`)
                .then(response => response.json())
                .then(report => {
                    document.getElementById('editReportId').value = report.id;
                    document.getElementById('editReportTitle').value = report.title;
                    document.getElementById('editReportContent').value = report.content;
                    document.getElementById('editReportLocation').value = report.location;
                    editReportModal.show();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error loading report for editing. Please try again.');
                });
        });
    });
    
    // Submit updated report
    document.getElementById('updateReport').addEventListener('click', function() {
        const reportId = document.getElementById('editReportId').value;
        const title = document.getElementById('editReportTitle').value;
        const content = document.getElementById('editReportContent').value;
        const location = document.getElementById('editReportLocation').value;
        
        if (!title || !content || !location) {
            alert('Please fill in all fields');
            return;
        }
        
        fetch(`/api/reports/${reportId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                title: title,
                content: content,
                location: location
            })
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            }
            throw new Error('Network response was not ok');
        })
        .then(data => {
            editReportModal.hide();
            // Reload page to show updated report
            window.location.reload();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating report. Please try again.');
        });
    });
    
    // Open delete confirmation modal
    document.querySelectorAll('.delete-report').forEach(button => {
        button.addEventListener('click', function() {
            const reportId = this.getAttribute('data-id');
            document.getElementById('deleteReportId').value = reportId;
            deleteReportModal.show();
        });
    });
    
    // Confirm delete report
    document.getElementById('confirmDelete').addEventListener('click', function() {
        const reportId = document.getElementById('deleteReportId').value;
        
        fetch(`/api/reports/${reportId}`, {
            method: 'DELETE'
        })
        .then(response => {
            if (response.ok) {
                deleteReportModal.hide();
                // Reload page to update report list
                window.location.reload();
            } else {
                throw new Error('Network response was not ok');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting report. Please try again.');
        });
    });
</script>
{% endblock %}
