<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AgroMap Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body { font-family: Arial, sans-serif; margin: 0; background: #f6f8fa; }
        .dashboard-container { display: flex; min-height: 100vh; }
        .sidebar { width: 220px; background: #263238; color: #fff; padding: 24px 0; display: flex; flex-direction: column; }
        .sidebar h2 { margin: 0 0 24px 24px; font-size: 1.3em; }
        .sidebar nav a { color: #b0bec5; text-decoration: none; padding: 12px 24px; display: block; border-left: 4px solid transparent; transition: 0.2s; }
        .sidebar nav a.active, .sidebar nav a:hover { color: #fff; background: #37474f; border-left: 4px solid #4caf50; }
        .main-content { flex: 1; padding: 32px; }
        .dashboard-header { font-size: 2em; margin-bottom: 16px; color: #263238; }
        .dashboard-widgets { display: flex; gap: 24px; flex-wrap: wrap; }
        .widget { background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #0001; padding: 24px; min-width: 220px; flex: 1; }
        .widget h3 { margin-top: 0; color: #4caf50; }
        .search-bar { margin-bottom: 32px; }
        .search-bar input[type="text"] { padding: 8px 12px; border-radius: 4px; border: 1px solid #b0bec5; width: 240px; }
        .search-bar button { padding: 8px 16px; border-radius: 4px; border: none; background: #4caf50; color: #fff; margin-left: 8px; cursor: pointer; }
        table { width: 100%; border-collapse: collapse; margin-top: 16px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #f0f0f0; }
        .chart-container {
            margin: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        #map { height: 400px; }

        /* Custom styles for the visualization components */
        .popup-content {
            padding: 10px;
        }
        .popup-content h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
        }
        .custom-popup .leaflet-popup-content-wrapper {
            border-radius: 8px;
            box-shadow: 0 3px 14px rgba(0,0,0,0.2);
        }
        .info {
            padding: 6px 8px;
            font: 14px/16px Arial, Helvetica, sans-serif;
            background: white;
            background: rgba(255,255,255,0.8);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
        }
        .legend {
            line-height: 18px;
            color: #555;
        }
        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.7;
        }

        .info {
            padding: 6px 8px;
            font: 14px/16px Arial, sans-serif;
            background: white;
            background: rgba(255, 255, 255, 0.8);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            border-radius: 5px;
        }

        .info h4 {
            margin: 0 0 5px;
            color: #777;
        }

        .visualization-controls {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .control-group {
            margin-bottom: 10px;
        }

        .control-group label {
            display: block;
            margin-bottom: 5px;
            color: #666;
        }

        select.control-input {
            width: 200px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }

        .map-container {
            position: relative;
            height: 500px;
            margin-bottom: 20px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <aside class="sidebar">
            <h2>AgroMap</h2>
            <nav>
                <a href="/dashboard" class="active">Dashboard</a>
                <a href="/">Map</a>
                <a href="#">Reports</a>
                <a href="#">Analytics</a>
                <a href="#">Settings</a>
            </nav>
        </aside>
        <main class="main-content">
            <div class="dashboard-header">Dashboard Overview</div>
            <div class="search-bar">
                <input type="text" id="dashboard-search" placeholder="Search users, reports, or locations...">
                <button onclick="alert('Search not yet implemented')">Search</button>
            </div>
            <form class="widget" style="max-width:400px;margin-bottom:32px;" method="post" action="/submit" enctype="multipart/form-data" onsubmit="return validateCropForm(event)">
                <h3>Submit Crop Report</h3>
                <div id="form-error" style="color:red;display:none;"></div>
                <label>Crop Type:<br><input type="text" name="crop_type" required></label><br><br>
                <label>Latitude:<br><input type="number" name="latitude" step="any" required></label><br><br>
                <label>Longitude:<br><input type="number" name="longitude" step="any" required></label><br><br>
                <label>Area Size (ha):<br><input type="number" name="area_size" step="any" required></label><br><br>
                <label>Attach File:<br><input type="file" name="attachment"></label><br><br>
                <button type="submit">Submit</button>
            </form>
            <script>
            function validateCropForm(event) {
                var form = event.target;
                var cropType = form.crop_type.value.trim();
                var lat = form.latitude.value;
                var lon = form.longitude.value;
                var area = form.area_size.value;
                var errorDiv = document.getElementById('form-error');
                errorDiv.style.display = 'none';
                if (!cropType || isNaN(lat) || isNaN(lon) || isNaN(area)) {
                    errorDiv.textContent = 'All fields are required and must be valid.';
                    errorDiv.style.display = 'block';
                    event.preventDefault();
                    return false;
                }
                return true;
            }
            </script>
            <div class="dashboard-widgets">
                <div class="widget">
                    <h3>Active Users</h3>
                    <p>--</p>
                </div>
                <div class="widget">
                    <h3>Crop Reports</h3>
                    <p>--</p>
                </div>
                <div class="widget">
                    <h3>Weather Alerts</h3>
                    <p>--</p>
                </div>
                <div class="widget">
                    <h3>System Health</h3>
                    <p>--</p>
                </div>
            </div>
            <!-- Chart.js integration -->
            <div class="widget" style="margin-top:32px;">
                <h3>Crop Reports Overview</h3>
                <canvas id="cropChart" width="400" height="180"></canvas>
            </div>
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script>
            // Fetch crop report data and render a bar chart
            fetch('/api/reports')
                .then(res => res.json())
                .then(data => {
                    const cropCounts = {};
                    data.forEach(r => {
                        cropCounts[r.crop_type] = (cropCounts[r.crop_type] || 0) + 1;
                    });
                    const ctx = document.getElementById('cropChart').getContext('2d');
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: Object.keys(cropCounts),
                            datasets: [{
                                label: 'Crop Reports',
                                data: Object.values(cropCounts),
                                backgroundColor: '#4caf50',
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: { legend: { display: false } },
                            scales: { y: { beginAtZero: true } }
                        }
                    });
                });
            </script>
            <!-- Data Table for Crop Reports -->
            <div class="widget" style="margin-top:32px;overflow-x:auto;">
                <h3>Crop Reports Table</h3>
                <table id="cropTable" border="0" cellpadding="8" style="width:100%;border-collapse:collapse;">
                    <thead>
                        <tr style="background:#f0f0f0;">
                            <th>ID</th>
                            <th>Crop Type</th>
                            <th>Latitude</th>
                            <th>Longitude</th>
                            <th>Area Size (ha)</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <script>
            // Populate crop reports data table with sorting and pagination
            let cropData = [];
            let currentSort = { col: null, asc: true };
            let currentPage = 1;
            const pageSize = 10;
            function renderTable(data) {
                const tbody = document.getElementById('cropTable').querySelector('tbody');
                tbody.innerHTML = '';
                const start = (currentPage - 1) * pageSize;
                const end = start + pageSize;
                data.slice(start, end).forEach(r => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${r.id}</td><td>${r.crop_type}</td><td>${r.latitude}</td><td>${r.longitude}</td><td>${r.area_size}</td><td>${r.created_at ? r.created_at : ''}</td>`;
                    tbody.appendChild(tr);
                });
                renderPagination(data.length);
            }
            function sortTable(col) {
                if (currentSort.col === col) {
                    currentSort.asc = !currentSort.asc;
                } else {
                    currentSort.col = col;
                    currentSort.asc = true;
                }
                cropData.sort((a, b) => {
                    let v1 = a[col], v2 = b[col];
                    if (typeof v1 === 'string') v1 = v1.toLowerCase();
                    if (typeof v2 === 'string') v2 = v2.toLowerCase();
                    if (v1 < v2) return currentSort.asc ? -1 : 1;
                    if (v1 > v2) return currentSort.asc ? 1 : -1;
                    return 0;
                });
                currentPage = 1;
                renderTable(cropData);
            }
            function renderPagination(total) {
                let pagDiv = document.getElementById('pagination');
                if (!pagDiv) {
                    pagDiv = document.createElement('div');
                    pagDiv.id = 'pagination';
                    pagDiv.style.margin = '16px 0';
                    document.getElementById('cropTable').parentNode.appendChild(pagDiv);
                }
                pagDiv.innerHTML = '';
                const pageCount = Math.ceil(total / pageSize);
                for (let i = 1; i <= pageCount; i++) {
                    const btn = document.createElement('button');
                    btn.textContent = i;
                    btn.style.margin = '0 2px';
                    btn.disabled = (i === currentPage);
                    btn.onclick = () => { currentPage = i; renderTable(cropData); };
                    pagDiv.appendChild(btn);
                }
            }
            fetch('/api/reports')
                .then(res => res.json())
                .then(data => {
                    cropData = data;
                    renderTable(cropData);
                });
            document.addEventListener('DOMContentLoaded', function() {
                const ths = document.querySelectorAll('#cropTable th');
                const keys = ['id', 'crop_type', 'latitude', 'longitude', 'area_size', 'created_at'];
                ths.forEach((th, idx) => {
                    th.style.cursor = 'pointer';
                    th.title = 'Sort';
                    th.addEventListener('click', () => sortTable(keys[idx]));
                });
            });
            </script>
            <div class="widget" style="margin-top:32px;">
                <h3>Current Weather</h3>
                <div id="weather-box">Loading...</div>
            </div>
            <script>
            // Fetch and display current weather for Tashkent (default)
            function fetchWeather(lat = 41.3111, lon = 69.2797) {
                fetch(`/api/weather?lat=${lat}&lon=${lon}`)
                    .then(res => res.json())
                    .then(data => {
                        const box = document.getElementById('weather-box');
                        if (data.error) {
                            box.textContent = 'Weather unavailable';
                        } else {
                            box.innerHTML = `<b>${data.location || 'Location'}</b><br>
                                ${data.weather} (${data.description})<br>
                                Temp: ${data.temp}°C<br>
                                Humidity: ${data.humidity}%<br>
                                Wind: ${data.wind} m/s`;
                        }
                    });
            }
            fetchWeather();
            </script>
            <div class="widget" style="margin-top:32px;">
                <h3>5-Day Forecast</h3>
                <table id="forecastTable" border="0" cellpadding="8" style="width:100%;border-collapse:collapse;">
                    <thead>
                        <tr style="background:#f0f0f0;">
                            <th>Date</th>
                            <th>Weather</th>
                            <th>Description</th>
                            <th>Temp (°C)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <script>
            // Fetch and display 5-day weather forecast for Tashkent (default)
            function fetchForecast(lat = 41.3111, lon = 69.2797) {
                fetch(`/api/forecast?lat=${lat}&lon=${lon}`)
                    .then(res => res.json())
                    .then(data => {
                        const tbody = document.getElementById('forecastTable').querySelector('tbody');
                        tbody.innerHTML = '';
                        if (Array.isArray(data)) {
                            data.forEach(f => {
                                const tr = document.createElement('tr');
                                tr.innerHTML = `<td>${f.date}</td><td>${f.weather}</td><td>${f.description}</td><td>${f.temp}</td>`;
                                tbody.appendChild(tr);
                            });
                        } else {
                            tbody.innerHTML = '<tr><td colspan="4">Forecast unavailable</td></tr>';
                        }
                    });
            }
            fetchForecast();
            </script>
            <!-- Leaflet map and Chart.js integration -->
            <div class="widget" style="margin-top:32px;">
                <h3>Agricultural Data Visualization</h3>
                <div class="visualization-container">
                    <div class="controls">
                        <select id="visualizationType" class="control-select">
                            <option value="heatmap">Heatmap</option>
                            <option value="choropleth">Choropleth</option>
                            <option value="timeseries">Time Series</option>
                        </select>
                        
                        <select id="cropType" class="control-select">
                            <option value="">All Crops</option>
                            <option value="wheat">Wheat</option>
                            <option value="cotton">Cotton</option>
                            <option value="rice">Rice</option>
                            <option value="corn">Corn</option>
                        </select>

                        <select id="timeInterval" class="control-select" style="display: none;">
                            <option value="day">Daily</option>
                            <option value="week">Weekly</option>
                            <option value="month">Monthly</option>
                            <option value="year">Yearly</option>
                        </select>
                    </div>

                    <div id="mapContainer">
                        <div id="map"></div>
                        <div id="info" class="info" style="display: none;"></div>
                    </div>
                    <div class="chart-container">
                        <canvas id="timeSeriesChart"></canvas>
                    </div>
                </div>

                <style>
                    .visualization-container {
                        background: white;
                        border-radius: 8px;
                        padding: 20px;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    }

                    .controls {
                        margin-bottom: 20px;
                        display: flex;
                        gap: 15px;
                        flex-wrap: wrap;
                    }

                    .control-select {
                        padding: 8px 12px;
                        border: 2px solid #3498db;
                        border-radius: 4px;
                        font-size: 14px;
                        color: #2c3e50;
                        background-color: white;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    }

                    .control-select:hover {
                        border-color: #2980b9;
                    }

                    #mapContainer {
                        position: relative;
                        height: 500px;
                        margin-bottom: 20px;
                    }

                    #map {
                        height: 100%;
                        border-radius: 8px;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    }

                    .info {
                        padding: 6px 8px;
                        font: 14px/16px Arial, sans-serif;
                        background: white;
                        background: rgba(255,255,255,0.9);
                        box-shadow: 0 0 15px rgba(0,0,0,0.2);
                        border-radius: 5px;
                        position: absolute;
                        top: 10px;
                        right: 10px;
                        z-index: 1000;
                    }

                    .chart-container {
                        background: white;
                        padding: 20px;
                        border-radius: 8px;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    }

                    .legend {
                        line-height: 18px;
                        color: #555;
                    }

                    .legend i {
                        width: 18px;
                        height: 18px;
                        float: left;
                        margin-right: 8px;
                        opacity: 0.7;
                    }
                </style>
            </div>
            <script>
                // Initialize map
                const map = L.map('map').setView([41.3775, 64.5853], 6);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                
                let currentLayer = null;
                let timeSeriesChart = null;

                // Event listeners
                document.getElementById('visualizationType').addEventListener('change', updateVisualization);
                document.getElementById('cropType').addEventListener('change', updateVisualization);
                document.getElementById('timeInterval').addEventListener('change', updateVisualization);

                function updateVisualization() {
                    const visType = document.getElementById('visualizationType').value;
                    const cropType = document.getElementById('cropType').value;
                    const timeInterval = document.getElementById('timeInterval').value;

                    // Show/hide time interval selector
                    document.getElementById('timeInterval').style.display = 
                        visType === 'timeseries' ? 'inline' : 'none';

                    if (currentLayer) {
                        map.removeLayer(currentLayer);
                    }

                    if (visType === 'heatmap') {
                        loadHeatmap(cropType);
                    } else if (visType === 'choropleth') {
                        loadChoropleth(cropType);
                    } else if (visType === 'timeseries') {
                        loadTimeSeries(cropType, timeInterval);
                    }
                }

                // Add custom styles for the visualization components
                function loadHeatmap(cropType) {
                    fetch(`/api/heatmap?crop_type=${cropType}`)
                        .then(res => res.json())
                        .then(data => {
                            if (currentLayer) {
                                map.removeLayer(currentLayer);
                            }
                            currentLayer = L.heatLayer(
                                data.map(point => [point.lat, point.lng, point.weight]),
                                {
                                    radius: 25,
                                    blur: 15,
                                    maxZoom: 10,
                                    gradient: {
                                        0.4: '#ffffb2',
                                        0.6: '#fd8d3c',
                                        0.8: '#f03b20',
                                        1.0: '#bd0026'
                                    }
                                }
                            ).addTo(map);
                        });
                }

                async function loadChoropleth(cropType) {
                    fetch(`/api/choropleth?crop_type=${cropType}`)
                        .then(res => res.json())
                        .then(data => {
                            if (currentLayer) {
                                map.removeLayer(currentLayer);
                            }

                            // Add legend if it doesn't exist
                            let legend = L.control({ position: 'bottomright' });
                            legend.onAdd = function(map) {
                                let div = L.DomUtil.create('div', 'info legend');
                                let grades = [0, 10, 20, 50, 100, 200, 500, 1000];
                                let colors = ['#FFEDA0', '#FED976', '#FEB24C', '#FD8D3C', '#FC4E2A', '#E31A1C', '#BD0026', '#800026'];
                                
                                div.innerHTML = '<strong>Area Size (ha)</strong><br>';
                                for (let i = 0; i < grades.length; i++) {
                                    div.innerHTML +=
                                        '<i style="background:' + colors[i] + '"></i> ' +
                                        grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : '+');
                                }
                                return div;
                            };

                            currentLayer = L.geoJSON(data, {
                                style: function(feature) {
                                    return {
                                        fillColor: getColor(feature.properties.value),
                                        weight: 2,
                                        opacity: 1,
                                        color: 'white',
                                        fillOpacity: 0.7,
                                        dashArray: '3'
                                    };
                                },
                                onEachFeature: function(feature, layer) {
                                    layer.on({
                                        mouseover: function(e) {
                                            let layer = e.target;
                                            layer.setStyle({
                                                weight: 3,
                                                color: '#666',
                                                dashArray: '',
                                                fillOpacity: 0.9
                                            });
                                            layer.bringToFront();
                                            updateInfo(feature.properties);
                                        },
                                        mouseout: function(e) {
                                            currentLayer.resetStyle(e.target);
                                            resetInfo();
                                        },
                                        click: function(e) {
                                            map.fitBounds(e.target.getBounds());
                                        }
                                    });

                                    // Popup content
                                    layer.bindPopup(
                                        `<div class="popup-content">
                                            <h4>${feature.properties.name}</h4>
                                            <p>Total Area: ${feature.properties.area.toFixed(2)} ha</p>
                                            <p>Report Count: ${feature.properties.count}</p>
                                        </div>",
                                        { className: 'custom-popup' }
                                    );
                                }
                            }).addTo(map);

                            legend.addTo(map);
                        });
                }

                async function loadTimeSeries(cropType, interval) {
                    const response = await fetch(`/api/timeseries?crop_type=${cropType}&interval=${interval}`);
                    const data = await response.json();
                    
                    const ctx = document.getElementById('timeSeriesChart').getContext('2d');
                    
                    if (timeSeriesChart) {
                        timeSeriesChart.destroy();
                    }
                    
                    timeSeriesChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.map(d => new Date(d.date).toLocaleDateString()),
                            datasets: [
                                {
                                    label: 'Total Area (ha)',
                                    data: data.map(d => d.total_area),
                                    borderColor: '#4CAF50',
                                    backgroundColor: 'rgba(76, 175, 80, 0.1)',
                                    tension: 0.3,
                                    fill: true
                                },
                                {
                                    label: 'Report Count',
                                    data: data.map(d => d.report_count),
                                    borderColor: '#2196F3',
                                    backgroundColor: 'rgba(33, 150, 243, 0.1)',
                                    tension: 0.3,
                                    fill: true
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'top',
                                },
                                title: {
                                    display: true,
                                    text: 'Crop Reports Over Time'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        drawBorder: false
                                    }
                                },
                                x: {
                                    grid: {
                                        display: false
                                    }
                                }
                            },
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            }
                        }
                    });
                }

                function getColor(value) {
                    return value > 1000 ? '#800026' :
                           value > 500  ? '#BD0026' :
                           value > 200  ? '#E31A1C' :
                           value > 100  ? '#FC4E2A' :
                           value > 50   ? '#FD8D3C' :
                           value > 20   ? '#FEB24C' :
                           value > 10   ? '#FED976' :
                                      '#FFEDA0';
                }

                // Map initialization and controls
                let currentLayer, timeSeriesChart, infoControl;

                function initMap() {
                    // Initialize the map centered on Uzbekistan
                    map = L.map('map').setView([41.3775, 64.5853], 6);
                    
                    // Add tile layer with attribution
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '© OpenStreetMap contributors'
                    }).addTo(map);

                    // Initialize info control
                    infoControl = L.control();
                    infoControl.onAdd = function(map) {
                        this._div = L.DomUtil.create('div', 'info');
                        this.update();
                        return this._div;
                    };
                    infoControl.update = function(props) {
                        this._div.innerHTML = props ? 
                            `<h4>${props.name}</h4>
                             <b>Area:</b> ${props.area.toFixed(2)} ha<br>
                             <b>Reports:</b> ${props.count}` :
                            'Hover over a region';
                    };
                    infoControl.addTo(map);

                    // Event listeners for controls
                    document.getElementById('visualizationType').addEventListener('change', updateVisualization);
                    document.getElementById('cropType').addEventListener('change', updateVisualization);
                    document.getElementById('timeInterval').addEventListener('change', updateVisualization);
                }

                function updateVisualization() {
                    const visType = document.getElementById('visualizationType').value;
                    const cropType = document.getElementById('cropType').value;
                    const timeInterval = document.getElementById('timeInterval').value;

                    // Show/hide controls based on visualization type
                    document.getElementById('timeInterval').style.display = 
                        visType === 'timeseries' ? 'inline' : 'none';
                    document.getElementById('map').style.display = 
                        visType === 'timeseries' ? 'none' : 'block';
                    document.querySelector('.chart-container').style.display = 
                        visType === 'timeseries' ? 'block' : 'none';

                    // Clear existing layers
                    if (currentLayer) {
                        map.removeLayer(currentLayer);
                    }

                    // Update visualization based on type
                    switch(visType) {
                        case 'heatmap':
                            loadHeatmap(cropType);
                            break;
                        case 'choropleth':
                            loadChoropleth(cropType);
                            break;
                        case 'timeseries':
                            loadTimeSeries(cropType, timeInterval);
                            break;
                    }
                }

                // Initialize map when document is ready
                document.addEventListener('DOMContentLoaded', initMap);
            </script>
        </main>
    </div>
</body>
</html>
