{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1 class="mb-4">Interactive Map</h1>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div id="map-container" style="height: 600px;"></div>
    </div>
</div>

<!-- Floating Action Buttons -->
<button id="report-btn" title="Report Issue">üìù</button>
<button id="locate-btn" title="My Location">üìç</button>

<!-- Report Modal -->
<div class="modal fade" id="reportModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Report</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="reportForm">
                    <div class="mb-3">
                        <label for="reportTitle" class="form-label">Title</label>
                        <input type="text" class="form-control" id="reportTitle" required>
                    </div>
                    <div class="mb-3">
                        <label for="reportContent" class="form-label">Description</label>
                        <textarea class="form-control" id="reportContent" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="reportLocation" class="form-label">Location</label>
                        <input type="text" class="form-control" id="reportLocation" readonly>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="submitReport">Submit Report</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Initialize map
    let map = L.map('map-container').setView([41.3775, 64.5853], 6);
    
    // Add tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
    
    // Get elements
    const reportBtn = document.getElementById('report-btn');
    const locateBtn = document.getElementById('locate-btn');
    const reportModal = new bootstrap.Modal(document.getElementById('reportModal'));
    const reportForm = document.getElementById('reportForm');
    const reportLocationInput = document.getElementById('reportLocation');
    const submitReportBtn = document.getElementById('submitReport');
    
    let currentMarker = null;
    let userLocation = null;
    
    // Report button click handler
    reportBtn.addEventListener('click', function() {
        if (userLocation) {
            reportLocationInput.value = `${userLocation.lat.toFixed(5)}, ${userLocation.lng.toFixed(5)}`;
            reportModal.show();
        } else {
            alert('Please use the location button to get your position first.');
        }
    });
    
    // Locate button click handler
    locateBtn.addEventListener('click', function() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                userLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                
                if (currentMarker) {
                    map.removeLayer(currentMarker);
                }
                
                currentMarker = L.marker([userLocation.lat, userLocation.lng]).addTo(map);
                currentMarker.bindPopup("Your location").openPopup();
                
                map.setView([userLocation.lat, userLocation.lng], 13);
            }, function(error) {
                console.error('Error getting location:', error);
                alert('Unable to get your location. Please check permissions.');
            });
        } else {
            alert('Geolocation is not supported by your browser.');
        }
    });
    
    // Submit report handler
    submitReportBtn.addEventListener('click', function() {
        const title = document.getElementById('reportTitle').value;
        const content = document.getElementById('reportContent').value;
        
        if (!title || !content) {
            alert('Please fill all required fields');
            return;
        }
        
        fetch('/api/reports', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                title: title,
                content: content,
                location: reportLocationInput.value
            })
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            }
            throw new Error('Network response was not ok');
        })
        .then(data => {
            alert('Report submitted successfully');
            reportModal.hide();
            document.getElementById('reportTitle').value = '';
            document.getElementById('reportContent').value = '';
        })
        .catch(error => {
            console.error('Error submitting report:', error);
            alert('Error submitting report. Please try again.');
        });
    });
    
    // Load field data from API
    fetch('/api/fields')
        .then(response => response.json())
        .then(fields => {
            fields.forEach(field => {
                if (field.geometry) {
                    L.geoJSON(field.geometry, {
                        style: {
                            color: '#4CAF50',
                            weight: 2,
                            opacity: 0.7
                        }
                    }).bindPopup(`
                        <strong>${field.name}</strong><br>
                        Crop: ${field.crop_name || 'Not specified'}<br>
                        Area: ${field.area} hectares<br>
                        Planting: ${field.planting_date || 'Not specified'}<br>
                        Harvest: ${field.harvest_date || 'Not specified'}
                    `).addTo(map);
                }
            });
        })
        .catch(error => console.error('Error loading fields:', error));
    
    // Check if offline
    if (!navigator.onLine) {
        alert('You are currently offline. Map functionality may be limited.');
    }
</script>
{% endblock %}
