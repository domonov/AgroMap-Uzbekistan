{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1 class="mb-4">Field Management</h1>
        <div class="d-flex justify-content-between mb-4">
            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addFieldModal">
                <i class="bi bi-plus-circle"></i> Add New Field
            </button>
            <a href="{{ url_for('map') }}" class="btn btn-primary">
                <i class="bi bi-map"></i> View on Map
            </a>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Location</th>
                                <th>Area (ha)</th>
                                <th>Crop</th>
                                <th>Planting Date</th>
                                <th>Harvest Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for field in fields %}
                            <tr>
                                <td>{{ field.name }}</td>
                                <td>{{ field.location }}</td>
                                <td>{{ field.area }}</td>
                                <td>{{ field.crop.name if field.crop else 'Not set' }}</td>
                                <td>{{ field.planting_date.strftime('%Y-%m-%d') if field.planting_date else 'Not set' }}</td>
                                <td>{{ field.harvest_date.strftime('%Y-%m-%d') if field.harvest_date else 'Not set' }}</td>
                                <td>
                                    <button class="btn btn-sm btn-primary view-field" data-id="{{ field.id }}">View</button>
                                    <button class="btn btn-sm btn-warning edit-field" data-id="{{ field.id }}">Edit</button>
                                    <button class="btn btn-sm btn-danger delete-field" data-id="{{ field.id }}">Delete</button>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="7" class="text-center">No fields found. Add your first field!</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Field Modal -->
<div class="modal fade" id="addFieldModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Field</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addFieldForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="fieldName" class="form-label">Field Name</label>
                                <input type="text" class="form-control" id="fieldName" required>
                            </div>
                            <div class="mb-3">
                                <label for="fieldLocation" class="form-label">Location</label>
                                <input type="text" class="form-control" id="fieldLocation" required>
                            </div>
                            <div class="mb-3">
                                <label for="fieldArea" class="form-label">Area (hectares)</label>
                                <input type="number" class="form-control" id="fieldArea" step="0.01" min="0" required>
                            </div>
                            <div class="mb-3">
                                <label for="fieldCrop" class="form-label">Crop</label>
                                <select class="form-select" id="fieldCrop">
                                    <option value="">Select a crop</option>
                                    <!-- Crops will be loaded dynamically -->
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="fieldPlantingDate" class="form-label">Planting Date</label>
                                <input type="date" class="form-control" id="fieldPlantingDate">
                            </div>
                            <div class="mb-3">
                                <label for="fieldHarvestDate" class="form-label">Expected Harvest Date</label>
                                <input type="date" class="form-control" id="fieldHarvestDate">
                            </div>
                            <div class="mb-3">
                                <label for="fieldGeometry" class="form-label">Field Boundary (GeoJSON)</label>
                                <textarea class="form-control" id="fieldGeometry" rows="6" placeholder='{"type":"Polygon","coordinates":[[longitude,latitude],[longitude,latitude],...]}' required></textarea>
                                <small class="text-muted">You can draw the boundary on the map page and copy the GeoJSON here.</small>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="submitField">Add Field</button>
            </div>
        </div>
    </div>
</div>

<!-- View Field Modal -->
<div class="modal fade" id="viewFieldModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewFieldName"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Location:</strong> <span id="viewFieldLocation"></span></p>
                        <p><strong>Area:</strong> <span id="viewFieldArea"></span> hectares</p>
                        <p><strong>Crop:</strong> <span id="viewFieldCrop"></span></p>
                        <p><strong>Planting Date:</strong> <span id="viewFieldPlantingDate"></span></p>
                        <p><strong>Expected Harvest Date:</strong> <span id="viewFieldHarvestDate"></span></p>
                    </div>
                    <div class="col-md-6">
                        <div id="viewFieldMap" style="height: 300px;"></div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-12">
                        <h6>Weather Forecast</h6>
                        <div id="viewFieldWeather" class="d-flex overflow-auto">
                            <p>Loading weather data...</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Field Modal -->
<div class="modal fade" id="editFieldModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Field</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editFieldForm">
                    <input type="hidden" id="editFieldId">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editFieldName" class="form-label">Field Name</label>
                                <input type="text" class="form-control" id="editFieldName" required>
                            </div>
                            <div class="mb-3">
                                <label for="editFieldLocation" class="form-label">Location</label>
                                <input type="text" class="form-control" id="editFieldLocation" required>
                            </div>
                            <div class="mb-3">
                                <label for="editFieldArea" class="form-label">Area (hectares)</label>
                                <input type="number" class="form-control" id="editFieldArea" step="0.01" min="0" required>
                            </div>
                            <div class="mb-3">
                                <label for="editFieldCrop" class="form-label">Crop</label>
                                <select class="form-select" id="editFieldCrop">
                                    <option value="">Select a crop</option>
                                    <!-- Crops will be loaded dynamically -->
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editFieldPlantingDate" class="form-label">Planting Date</label>
                                <input type="date" class="form-control" id="editFieldPlantingDate">
                            </div>
                            <div class="mb-3">
                                <label for="editFieldHarvestDate" class="form-label">Expected Harvest Date</label>
                                <input type="date" class="form-control" id="editFieldHarvestDate">
                            </div>
                            <div class="mb-3">
                                <label for="editFieldGeometry" class="form-label">Field Boundary (GeoJSON)</label>
                                <textarea class="form-control" id="editFieldGeometry" rows="6" required></textarea>
                                <small class="text-muted">You can draw the boundary on the map page and copy the GeoJSON here.</small>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="updateField">Update Field</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Field Confirmation Modal -->
<div class="modal fade" id="deleteFieldModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this field? This action cannot be undone.</p>
                <input type="hidden" id="deleteFieldId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Initialize modals
    const addFieldModal = new bootstrap.Modal(document.getElementById('addFieldModal'));
    const viewFieldModal = new bootstrap.Modal(document.getElementById('viewFieldModal'));
    const editFieldModal = new bootstrap.Modal(document.getElementById('editFieldModal'));
    const deleteFieldModal = new bootstrap.Modal(document.getElementById('deleteFieldModal'));
    
    let viewMap = null;
    
    // Load crops for dropdown
    function loadCrops() {
        fetch('/api/crops')
            .then(response => response.json())
            .then(crops => {
                const addFieldCropSelect = document.getElementById('fieldCrop');
                const editFieldCropSelect = document.getElementById('editFieldCrop');
                
                // Clear existing options except the first one
                while (addFieldCropSelect.options.length > 1) {
                    addFieldCropSelect.remove(1);
                }
                
                while (editFieldCropSelect.options.length > 1) {
                    editFieldCropSelect.remove(1);
                }
                
                // Add crop options
                crops.forEach(crop => {
                    const addOption = document.createElement('option');
                    addOption.value = crop.id;
                    addOption.textContent = crop.name;
                    addFieldCropSelect.appendChild(addOption);
                    
                    const editOption = document.createElement('option');
                    editOption.value = crop.id;
                    editOption.textContent = crop.name;
                    editFieldCropSelect.appendChild(editOption);
                });
            })
            .catch(error => {
                console.error('Error loading crops:', error);
                alert('Error loading crop options. Please try again.');
            });
    }
    
    // Load crops when page loads
    loadCrops();
    
    // Submit new field
    document.getElementById('submitField').addEventListener('click', function() {
        const name = document.getElementById('fieldName').value;
        const location = document.getElementById('fieldLocation').value;
        const area = document.getElementById('fieldArea').value;
        const cropId = document.getElementById('fieldCrop').value;
        const plantingDate = document.getElementById('fieldPlantingDate').value;
        const harvestDate = document.getElementById('fieldHarvestDate').value;
        const geometryString = document.getElementById('fieldGeometry').value;
        
        if (!name || !location || !area || !geometryString) {
            alert('Please fill in all required fields');
            return;
        }
        
        let geometry;
        try {
            geometry = JSON.parse(geometryString);
        } catch (e) {
            alert('Invalid GeoJSON format. Please check and try again.');
            return;
        }
        
        fetch('/api/fields', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: name,
                location: location,
                area: parseFloat(area),
                crop_id: cropId || null,
                planting_date: plantingDate || null,
                harvest_date: harvestDate || null,
                geometry: geometry
            })
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            }
            throw new Error('Network response was not ok');
        })
        .then(data => {
            addFieldModal.hide();
            // Reset form
            document.getElementById('addFieldForm').reset();
            // Reload page to show new field
            window.location.reload();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error adding field. Please try again.');
        });
    });
    
    // View field details
    document.querySelectorAll('.view-field').forEach(button => {
        button.addEventListener('click', function() {
            const fieldId = this.getAttribute('data-id');
            
            fetch(`/api/fields/${fieldId}`)
                .then(response => response.json())
                .then(field => {
                    document.getElementById('viewFieldName').textContent = field.name;
                    document.getElementById('viewFieldLocation').textContent = field.location;
                    document.getElementById('viewFieldArea').textContent = field.area;
                    document.getElementById('viewFieldCrop').textContent = field.crop_name || 'Not set';
                    document.getElementById('viewFieldPlantingDate').textContent = field.planting_date || 'Not set';
                    document.getElementById('viewFieldHarvestDate').textContent = field.harvest_date || 'Not set';
                    
                    // Initialize map if not already done
                    if (!viewMap) {
                        viewMap = L.map('viewFieldMap').setView([41.3775, 64.5853], 6);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                        }).addTo(viewMap);
                    }
                    
                    // Clear existing layers
                    viewMap.eachLayer(layer => {
                        if (layer instanceof L.TileLayer === false) {
                            viewMap.removeLayer(layer);
                        }
                    });
                    
                    // Add field geometry to map
                    if (field.geometry) {
                        const geoJsonLayer = L.geoJSON(field.geometry, {
                            style: {
                                color: '#4CAF50',
                                weight: 2,
                                opacity: 0.7
                            }
                        }).addTo(viewMap);
                        
                        // Zoom to field boundary
                        viewMap.fitBounds(geoJsonLayer.getBounds());
                    }
                    
                    // Get weather data for field location
                    fetch(`/api/weather?location=${encodeURIComponent(field.location)}`)
                        .then(response => response.json())
                        .then(weatherData => {
                            const weatherContainer = document.getElementById('viewFieldWeather');
                            weatherContainer.innerHTML = '';
                            
                            if (weatherData.length === 0) {
                                weatherContainer.innerHTML = '<p>No weather data available for this location.</p>';
                                return;
                            }
                            
                            weatherData.forEach(day => {
                                const weatherCard = document.createElement('div');
                                weatherCard.className = 'card me-2 weather-card';
                                weatherCard.style.minWidth = '120px';
                                
                                const date = new Date(day.timestamp);
                                const formattedDate = date.toLocaleDateString();
                                
                                weatherCard.innerHTML = `
                                    <div class="card-body text-center">
                                        <h6>${formattedDate}</h6>
                                        <div class="display-6">${day.temperature}°C</div>
                                        <div>
                                            <small>Humidity: ${day.humidity}%</small><br>
                                            <small>Precip: ${day.precipitation}mm</small>
                                        </div>
                                    </div>
                                `;
                                
                                weatherContainer.appendChild(weatherCard);
                            });
                        })
                        .catch(error => {
                            console.error('Error loading weather data:', error);
                            document.getElementById('viewFieldWeather').innerHTML = 
                                '<p>Error loading weather data. Please try again later.</p>';
                        });
                    
                    viewFieldModal.show();
                    
                    // Fix map display issue
                    setTimeout(() => {
                        viewMap.invalidateSize();
                    }, 300);
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error loading field details. Please try again.');
                });
        });
    });
    
    // Open edit modal with field data
    document.querySelectorAll('.edit-field').forEach(button => {
        button.addEventListener('click', function() {
            const fieldId = this.getAttribute('data-id');
            
            fetch(`/api/fields/${fieldId}`)
                .then(response => response.json())
                .then(field => {
                    document.getElementById('editFieldId').value = field.id;
                    document.getElementById('editFieldName').value = field.name;
                    document.getElementById('editFieldLocation').value = field.location;
                    document.getElementById('editFieldArea').value = field.area;
                    document.getElementById('editFieldCrop').value = field.crop_id || '';
                    
                    if (field.planting_date) {
                        document.getElementById('editFieldPlantingDate').value = field.planting_date.split(' ')[0];
                    } else {
                        document.getElementById('editFieldPlantingDate').value = '';
                    }
                    
                    if (field.harvest_date) {
                        document.getElementById('editFieldHarvestDate').value = field.harvest_date.split(' ')[0];
                    } else {
                        document.getElementById('editFieldHarvestDate').value = '';
                    }
                    
                    document.getElementById('editFieldGeometry').value = JSON.stringify(field.geometry);
                    
                    editFieldModal.show();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error loading field for editing. Please try again.');
                });
        });
    });
    
    // Submit updated field
    document.getElementById('updateField').addEventListener('click', function() {
        const fieldId = document.getElementById('editFieldId').value;
        const name = document.getElementById('editFieldName').value;
        const location = document.getElementById('editFieldLocation').value;
        const area = document.getElementById('editFieldArea').value;
        const cropId = document.getElementById('editFieldCrop').value;
        const plantingDate = document.getElementById('editFieldPlantingDate').value;
        const harvestDate = document.getElementById('editFieldHarvestDate').value;
        const geometryString = document.getElementById('editFieldGeometry').value;
        
        if (!name || !location || !area || !geometryString) {
            alert('Please fill in all required fields');
            return;
        }
        
        let geometry;
        try {
            geometry = JSON.parse(geometryString);
        } catch (e) {
            alert('Invalid GeoJSON format. Please check and try again.');
            return;
        }
        
        fetch(`/api/fields/${fieldId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: name,
                location: location,
                area: parseFloat(area),
                crop_id: cropId || null,
                planting_date: plantingDate || null,
                harvest_date: harvestDate || null,
                geometry: geometry
            })
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            }
            throw new Error('Network response was not ok');
        })
        .then(data => {
            editFieldModal.hide();
            // Reload page to show updated field
            window.location.reload();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating field. Please try again.');
        });
    });
    
    // Open delete confirmation modal
    document.querySelectorAll('.delete-field').forEach(button => {
        button.addEventListener('click', function() {
            const fieldId = this.getAttribute('data-id');
            document.getElementById('deleteFieldId').value = fieldId;
            deleteFieldModal.show();
        });
    });
    
    // Confirm delete field
    document.getElementById('confirmDelete').addEventListener('click', function() {
        const fieldId = document.getElementById('deleteFieldId').value;
        
        fetch(`/api/fields/${fieldId}`, {
            method: 'DELETE'
        })
        .then(response => {
            if (response.ok) {
                deleteFieldModal.hide();
                // Reload page to update field list
                window.location.reload();
            } else {
                throw new Error('Network response was not ok');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting field. Please try again.');
        });
    });
</script>
{% endblock %}
