<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AgroMap - Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/map.css') }}" />
    <style>
        #map-controls {
            position: absolute;
            top: 60px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        .legend {
            background: white;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            line-height: 1.5;
        }
        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <div class="nav-bar">
        <a href="/dashboard">Dashboard</a>
        <a href="/" class="active">Map</a>
        <a href="#">Reports</a>
        <a href="#">Analytics</a>
        <a href="#">Settings</a>
    </div>
    
    <div id="map-controls">
        <div>
            <label for="visualization-type">Visualization:</label>
            <select id="visualization-type" onchange="updateVisualization()">
                <option value="markers">Markers</option>
                <option value="heatmap">Heatmap</option>
                <option value="choropleth">Choropleth</option>
            </select>
        </div>
        <div style="margin-top: 10px;">
            <label for="crop-type">Crop Type:</label>
            <select id="crop-type" onchange="updateVisualization()">
                <option value="">All Crops</option>
                <option value="wheat">Wheat</option>
                <option value="cotton">Cotton</option>
                <option value="rice">Rice</option>
                <option value="corn">Corn</option>
                <option value="vegetables">Vegetables</option>
                <option value="fruits">Fruits</option>
            </select>
        </div>
        <div style="margin-top: 10px;">
            <label for="metric-type">Metric:</label>
            <select id="metric-type" onchange="updateVisualization()">
                <option value="area">Area Size</option>
                <option value="count">Report Count</option>
            </select>
        </div>
    </div>
    
    <div id="map"></div>
    
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
    <script>
        // Base layers setup
        var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap contributors'
        });
        
        var satellite = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
            maxZoom: 19,
            subdomains:['mt0','mt1','mt2','mt3'],
            attribution: '© Google Satellite'
        });
        
        var map = L.map('map', {
            center: [41.3111, 69.2797],
            zoom: 7,
            layers: [osm]
        });
        
        var baseLayers = {
            "OpenStreetMap": osm,
            "Satellite": satellite
        };
        
        var overlays = {
            'Precipitation': L.tileLayer('https://tile.openweathermap.org/map/precipitation_new/{z}/{x}/{y}.png?appid={{ config.OPENWEATHERMAP_API_KEY }}', {
                attribution: 'Weather © OpenWeatherMap',
                opacity: 0.6
            }),
            'Clouds': L.tileLayer('https://tile.openweathermap.org/map/clouds_new/{z}/{x}/{y}.png?appid={{ config.OPENWEATHERMAP_API_KEY }}', {
                attribution: 'Weather © OpenWeatherMap',
                opacity: 0.5
            }),
            'Temperature': L.tileLayer('https://tile.openweathermap.org/map/temp_new/{z}/{x}/{y}.png?appid={{ config.OPENWEATHERMAP_API_KEY }}', {
                attribution: 'Weather © OpenWeatherMap',
                opacity: 0.5
            })
        };
        
        L.control.layers(baseLayers, overlays).addTo(map);

        // Layer groups
        var markerCluster = L.markerClusterGroup();
        var heatLayer = null;
        var choroplethLayer = null;
        var currentLayers = [];

        function clearLayers() {
            if (markerCluster) map.removeLayer(markerCluster);
            if (heatLayer) map.removeLayer(heatLayer);
            if (choroplethLayer) map.removeLayer(choroplethLayer);
            markerCluster.clearLayers();
            currentLayers = [];
        }

        function updateVisualization() {
            var visType = document.getElementById('visualization-type').value;
            var cropType = document.getElementById('crop-type').value;
            var metric = document.getElementById('metric-type').value;
            
            clearLayers();
            
            if (visType === 'markers') {
                updateMarkers(cropType);
            } else if (visType === 'heatmap') {
                updateHeatmap(cropType);
            } else if (visType === 'choropleth') {
                updateChoropleth(cropType, metric);
            }
        }

        // Marker visualization
        function updateMarkers(cropType) {
            var url = '/api/reports';
            if (cropType) url += '/filter?crop_type=' + encodeURIComponent(cropType);
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    data.forEach(report => {
                        var marker = L.marker([report.latitude, report.longitude]);
                        marker.bindPopup(
                            `<b>${report.crop_type}</b><br>
                            Area: ${report.area_size} ha<br>
                            Date: ${report.created_at || 'N/A'}`
                        );
                        markerCluster.addLayer(marker);
                    });
                    map.addLayer(markerCluster);
                });
        }

        // Heatmap visualization
        function updateHeatmap(cropType) {
            var url = '/api/heatmap';
            if (cropType) url += '?crop_type=' + encodeURIComponent(cropType);
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    heatLayer = L.heatLayer(data, {
                        radius: 25,
                        blur: 15,
                        maxZoom: 10,
                        gradient: {0.4: 'blue', 0.6: 'lime', 0.8: 'yellow', 1: 'red'}
                    });
                    map.addLayer(heatLayer);
                });
        }

        // Choropleth visualization
        function updateChoropleth(cropType, metric) {
            var url = '/api/choropleth?metric=' + metric;
            if (cropType) url += '&crop_type=' + encodeURIComponent(cropType);
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    // Remove existing choropleth and legend
                    if (choroplethLayer) {
                        map.removeLayer(choroplethLayer);
                        map.removeControl(legend);
                    }
                    
                    // Calculate color ranges
                    var values = data.features.map(f => f.properties.value);
                    var max = Math.max(...values);
                    var min = Math.min(...values);
                    
                    function getColor(value) {
                        var percentage = value ? (value - min) / (max - min) : 0;
                        if (percentage >= 0.8) return '#800026';
                        if (percentage >= 0.6) return '#BD0026';
                        if (percentage >= 0.4) return '#E31A1C';
                        if (percentage >= 0.2) return '#FC4E2A';
                        return '#FFEDA0';
                    }
                    
                    function style(feature) {
                        return {
                            fillColor: getColor(feature.properties.value),
                            weight: 2,
                            opacity: 1,
                            color: 'white',
                            dashArray: '3',
                            fillOpacity: 0.7
                        };
                    }
                    
                    choroplethLayer = L.geoJSON(data, {
                        style: style,
                        onEachFeature: function(feature, layer) {
                            var props = feature.properties;
                            layer.bindPopup(
                                `<b>${props.name}</b><br>
                                Area: ${props.area.toFixed(2)} ha<br>
                                Reports: ${props.count}`
                            );
                        }
                    }).addTo(map);
                    
                    // Add legend
                    var legend = L.control({position: 'bottomright'});
                    legend.onAdd = function(map) {
                        var div = L.DomUtil.create('div', 'legend');
                        var grades = [0, 0.2, 0.4, 0.6, 0.8].map(p => min + p * (max - min));
                        var labels = [];
                        
                        for (var i = 0; i < grades.length; i++) {
                            div.innerHTML +=
                                '<i style="background:' + getColor(grades[i] + 1) + '"></i> ' +
                                Math.round(grades[i]) + (grades[i + 1] ? '&ndash;' + Math.round(grades[i + 1]) + '<br>' : '+');
                        }
                        return div;
                    };
                    legend.addTo(map);
                });
        }

        // Initialize with markers
        updateVisualization();
    </script>
</body>
</html>
