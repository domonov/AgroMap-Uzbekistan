{% extends "base.html" %}
{% block content %}
<div class="visualization-container">
    <div class="controls">
        <select id="visualizationType" class="control-select">
            <option value="heatmap">Heatmap</option>
            <option value="choropleth">Choropleth</option>
            <option value="timeseries">Time Series</option>
        </select>
        
        <select id="cropType" class="control-select">
            <option value="">All Crops</option>
            <option value="wheat">Wheat</option>
            <option value="cotton">Cotton</option>
            <option value="rice">Rice</option>
            <option value="corn">Corn</option>
        </select>

        <select id="timeInterval" class="control-select" style="display: none;">
            <option value="day">Daily</option>
            <option value="week">Weekly</option>
            <option value="month">Monthly</option>
            <option value="year">Yearly</option>
        </select>
    </div>

    <div id="mapContainer">
        <div id="map"></div>
        <div id="info" class="info"></div>
    </div>
    <div class="chart-container" style="display: none;">
        <canvas id="timeSeriesChart"></canvas>
    </div>
</div>

<script>
let map, currentLayer, timeSeriesChart;

function initMap() {
    map = L.map('map').setView([41.3775, 64.5853], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);
}

async function loadHeatmap(cropType) {
    try {
        const response = await fetch(`/api/heatmap?crop_type=${cropType}`);
        const data = await response.json();
        
        if (currentLayer) {
            map.removeLayer(currentLayer);
        }
        
        currentLayer = L.heatLayer(
            data.map(point => [point.lat, point.lng, point.weight]),
            {
                radius: 25,
                blur: 15,
                maxZoom: 10,
                gradient: {
                    0.4: '#ffffb2',
                    0.6: '#fd8d3c',
                    0.8: '#f03b20',
                    1.0: '#bd0026'
                }
            }
        ).addTo(map);
    } catch (error) {
        console.error('Error loading heatmap:', error);
    }
}

async function loadChoropleth(cropType) {
    try {
        const response = await fetch(`/api/choropleth?crop_type=${cropType}`);
        const data = await response.json();
        
        if (currentLayer) {
            map.removeLayer(currentLayer);
        }

        const legend = new L.Control({ position: 'bottomright' });
        legend.onAdd = function() {
            const div = L.DomUtil.create('div', 'info legend');
            const grades = [0, 10, 20, 50, 100, 200, 500, 1000];
            const colors = ['#FFEDA0', '#FED976', '#FEB24C', '#FD8D3C', '#FC4E2A', '#E31A1C', '#BD0026', '#800026'];
            
            div.innerHTML = '<h4>Area Size (ha)</h4>';
            for (let i = 0; i < grades.length; i++) {
                div.innerHTML +=
                    '<i style="background:' + colors[i] + '"></i> ' +
                    grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : '+');
            }
            return div;
        };

        currentLayer = L.geoJSON(data, {
            style: function(feature) {
                return {
                    fillColor: getColor(feature.properties.value),
                    weight: 2,
                    opacity: 1,
                    color: 'white',
                    fillOpacity: 0.7,
                    dashArray: '3'
                };
            },
            onEachFeature: function(feature, layer) {
                layer.on({
                    mouseover: highlightFeature,
                    mouseout: resetHighlight,
                    click: zoomToFeature
                });
                
                layer.bindPopup(createPopupContent(feature.properties));
            }
        }).addTo(map);

        legend.addTo(map);
        updateInfo();
    } catch (error) {
        console.error('Error loading choropleth:', error);
    }
}

async function loadTimeSeries(cropType, interval) {
    try {
        const response = await fetch(`/api/timeseries?crop_type=${cropType}&interval=${interval}`);
        const data = await response.json();
        
        const ctx = document.getElementById('timeSeriesChart').getContext('2d');
        
        if (timeSeriesChart) {
            timeSeriesChart.destroy();
        }
        
        timeSeriesChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.map(d => new Date(d.date).toLocaleDateString()),
                datasets: [
                    {
                        label: 'Total Area (ha)',
                        data: data.map(d => d.total_area),
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        tension: 0.3,
                        fill: true
                    },
                    {
                        label: 'Report Count',
                        data: data.map(d => d.report_count),
                        borderColor: '#2196F3',
                        backgroundColor: 'rgba(33, 150, 243, 0.1)',
                        tension: 0.3,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'Crop Reports Over Time'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            drawBorder: false
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                }
            }
        });
    } catch (error) {
        console.error('Error loading time series:', error);
    }
}

function getColor(value) {
    return value > 1000 ? '#800026' :
           value > 500  ? '#BD0026' :
           value > 200  ? '#E31A1C' :
           value > 100  ? '#FC4E2A' :
           value > 50   ? '#FD8D3C' :
           value > 20   ? '#FEB24C' :
           value > 10   ? '#FED976' :
                      '#FFEDA0';
}

function highlightFeature(e) {
    const layer = e.target;
    layer.setStyle({
        weight: 3,
        color: '#666',
        dashArray: '',
        fillOpacity: 0.9
    });
    layer.bringToFront();
    updateInfo(layer.feature.properties);
}

function resetHighlight(e) {
    currentLayer.resetStyle(e.target);
    updateInfo();
}

function zoomToFeature(e) {
    map.fitBounds(e.target.getBounds());
}

function updateInfo(props) {
    const info = document.getElementById('info');
    info.innerHTML = props ? 
        `<h4>${props.name}</h4>
         <b>Area:</b> ${props.area.toFixed(2)} ha<br>
         <b>Reports:</b> ${props.count}` :
        'Hover over a region';
}

function createPopupContent(props) {
    return `
        <div class="popup-content">
            <h4>${props.name}</h4>
            <p>Total Area: ${props.area.toFixed(2)} ha</p>
            <p>Report Count: ${props.count}</p>
        </div>
    `;
}

function updateVisualization() {
    const visType = document.getElementById('visualizationType').value;
    const cropType = document.getElementById('cropType').value;
    const timeInterval = document.getElementById('timeInterval').value;

    // Show/hide elements based on visualization type
    document.getElementById('timeInterval').style.display = 
        visType === 'timeseries' ? 'inline' : 'none';
    document.getElementById('mapContainer').style.display = 
        visType === 'timeseries' ? 'none' : 'block';
    document.querySelector('.chart-container').style.display = 
        visType === 'timeseries' ? 'block' : 'none';

    // Update visualization
    switch(visType) {
        case 'heatmap':
            loadHeatmap(cropType);
            break;
        case 'choropleth':
            loadChoropleth(cropType);
            break;
        case 'timeseries':
            loadTimeSeries(cropType, timeInterval);
            break;
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    initMap();
    document.getElementById('visualizationType').addEventListener('change', updateVisualization);
    document.getElementById('cropType').addEventListener('change', updateVisualization);
    document.getElementById('timeInterval').addEventListener('change', updateVisualization);
    updateVisualization();
});
</script>

<style>
.visualization-container {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.controls {
    margin-bottom: 20px;
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
}

.control-select {
    padding: 8px 12px;
    border: 2px solid #3498db;
    border-radius: 4px;
    font-size: 14px;
    color: #2c3e50;
    background-color: white;
    cursor: pointer;
    transition: all 0.3s ease;
}

.control-select:hover {
    border-color: #2980b9;
}

#mapContainer {
    position: relative;
    height: 500px;
    margin-bottom: 20px;
}

#map {
    height: 100%;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.info {
    padding: 6px 8px;
    font: 14px/16px Arial, sans-serif;
    background: white;
    background: rgba(255,255,255,0.9);
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
    border-radius: 5px;
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 1000;
}

.legend {
    padding: 6px 8px;
    background: white;
    background: rgba(255,255,255,0.9);
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
    border-radius: 5px;
}

.legend h4 {
    margin: 0 0 5px;
    color: #777;
}

.legend i {
    width: 18px;
    height: 18px;
    float: left;
    margin-right: 8px;
    opacity: 0.7;
}

.popup-content {
    padding: 10px;
}

.popup-content h4 {
    margin: 0 0 10px 0;
    color: #2c3e50;
}

.chart-container {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
</style>
{% endblock %}
